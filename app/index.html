<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unscrambler</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <style>
      p.action {
        text-align: right;
      }
      div {
        display: none;
      }
      div.display {
        display: block;
      }
      #loading {
        text-align: center;
        color: var(--text-light);
      }
      footer a {
        color: var(--text-light) !important;
      }
    </style>
  </head>
  <body>
    <main>
      <p class="action">
        <textarea id="query" placeholder="Write a mix of Chinese and Englishâ€¦" maxlength="200"></textarea>
        <button id="unscramble" disabled>Unscramble</button>
      </p>
      <div id="instructions" class="display">
        <p>
          When you click <strong>Unscramble</strong>, an AI model will generate an English version of your input.
          The English version will then be translated into Chinese.
        </p>
        <p>
          Unscrambler uses a combination of <a href="https://platform.openai.com/docs/models/gpt-3-5" target="_blank">GPT-3.5 Turbo</a>
          and <a href="https://www.deepl.com/translator" target="_blank">DeepL</a>
          to interpret your input.
        </p>
      </div>
      <div id="loading">
        <p>
          <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="30px" viewBox="0 0 24 30" style="enable-background:new 0 0 50 50;" xml:space="preserve"><rect x="0" y="13" width="4" height="5" fill="currentColor"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0s" dur="0.6s" repeatCount="indefinite" /><animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0s" dur="0.6s" repeatCount="indefinite" /></rect><rect x="10" y="13" width="4" height="5" fill="currentColor"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.15s" dur="0.6s" repeatCount="indefinite" /><animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.15s" dur="0.6s" repeatCount="indefinite" /></rect><rect x="20" y="13" width="4" height="5" fill="currentColor"><animate attributeName="height" attributeType="XML" values="5;21;5" begin="0.3s" dur="0.6s" repeatCount="indefinite" /><animate attributeName="y" attributeType="XML" values="13; 5; 13" begin="0.3s" dur="0.6s" repeatCount="indefinite" /></rect></svg>
        </p>
      </div>
      <div id="output">
        <p>
          <em id="english"></em>
        </p>
        <p>
          <mark id="translated"></mark>
        </p>
        <details>
          <summary>Pinyin</summary>
          <p id="pinyin"></p>
        </details>
        <p class="action">
          <a id="details" href="#" target="_blank">Translation details</a>
        </p>
      </div>
    </main>
    <footer>
      <p>
        Unscrambler is an experimental language assistant developed by <a href="https://github.com/dwilding" target="_blank">Dave Wilding</a>.
        The interpretation of your input may be inaccurate.
        Don't believe everything that Unscrambler tells you!
      </p>
      <p>
        Acknowledgments:
        <a href="https://simplecss.org" target="_blank">Simple.css</a>,
        <a href="https://codepen.io/aurer" target="_blank">Aurer</a>,
        <a href="https://github.com/overtrue/pinyin" target="_blank">overtrue/pinyin</a>
      </p>
      <p>
        <a href="https://github.com/dwilding/unscrambler" target="_blank">Source code</a>
      </p>
    </footer>
    <script>
      const dom = {};
      for (const id of [
        "query",
        "unscramble",
        "instructions",
        "loading",
        "output",
        "english",
        "translated",
        "details",
        "pinyin"
      ]) {
        dom[id] = document.getElementById(id);
      }
      function restart() {
        const hash = parseHash();
        if (hash === null) {
          history.replaceState(null, null, "#zh");
        }
        else {
          dom.query.value = hash.query;
          unscramble();
        }
      }
      function parseHash() {
        if (window.location.hash == "") {
          return null;
        }
        const hashParts = window.location.hash.substring(1).split("/");
        if (hashParts.length < 2) {
          return null;
        }
        if (hashParts[0] != "zh") {
          return null;
        }
        const query = decodeURIComponent(hashParts[1]).trim().substring(0, 200);
        if (query == "") {
          return null;
        }
        return {
          lang: hashParts[0],
          query: query
        };
      }
      function canUnscramble() {
        const query = dom.query.value.trim();
        if (query == "") {
          return false;
        }
        const hash = parseHash();
        if (hash !== null && hash.query == query) {
          return false;
        }
        return true;
      }
      async function unscramble() {
        const query = dom.query.value.trim();
        dom.unscramble.disabled = true;
        dom.instructions.classList.remove("display");
        dom.loading.classList.add("display");
        dom.output.classList.remove("display");
        response = await fetch("/post-query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            query: query
          })
        });
        const result = await response.json();
        display(result);
        history.pushState({
          query: query,
          result: result
        }, null, `#zh/${query}`);
      }
      function display(result) {
        dom.instructions.classList.remove("display");
        dom.loading.classList.remove("display");
        dom.output.classList.add("display");
        dom.english.innerText = result.english;
        dom.translated.innerText = result.translated;
        dom.details.href = `https://www.deepl.com/translator#en/zh/${encodeURIComponent(result.english)}`;
        dom.pinyin.innerText = result.pinyin;
      }
      dom.query.addEventListener("input", event => {
        dom.unscramble.disabled = !canUnscramble();
      });
      dom.query.addEventListener("keydown", event => {
        if ("key" in event && event.key.toLowerCase() == "enter") {
          event.preventDefault();
          if (canUnscramble()) {
            unscramble();
          }
        }
      });
      dom.unscramble.addEventListener("click", event => {
        unscramble();
      });
      window.addEventListener("popstate", event => {
        dom.query.value = "";
        dom.unscramble.disabled = true;
        dom.instructions.classList.add("display");
        dom.loading.classList.remove("display");
        dom.output.classList.remove("display");
        if (event.state === null) {
          restart();
        }
        else {
          dom.query.value = event.state.query;
          display(event.state.result);
        }
      });
      restart();
    </script>
  </body>
</html>